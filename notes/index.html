<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PasteMini — Minimal Notes</title>
  <meta name="description" content="Catatan minimalis dengan Rich Text & Coding (textarea), share URL/WA, slug kustom, dan simpan/ambil dari Google Sheet. Siap untuk GitHub Pages." />
  <!--
    ================== GOOGLE SHEETS BACKEND (APPS SCRIPT) ==================
    1) Buat Google Spreadsheet. Pastikan sheet bernama 'Sheet1' dengan header: code | title | payload | updatedAt
    2) Extensions → Apps Script → tempel kode di bawah → Deploy → New deployment → Web app
       - Execute as: Me   •   Who has access: Anyone
       - Salin URL Web App dan ganti konstanta SHEET_API di bawah.

    ----- BEGIN APPS SCRIPT -----
    const SHEET_NAME = 'Sheet1';
    function _json(o){ return ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON); }
    function _findRowByCode(sh, code){ const vals = sh.getDataRange().getValues(); return vals.findIndex(r => (r[0]||'').toString().trim()===code); }

    function doGet(e){
      const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_NAME);
      const act = (e.parameter.action||'').toLowerCase();
      if (act==='ping') return _json({ok:true, ts:new Date().toISOString()});
      if (act==='get'){
        const code = (e.parameter.code||'').trim();
        const idx = _findRowByCode(sh, code);
        if (idx>-1){ const row = sh.getRange(idx+1,1,1,4).getValues()[0]; return _json({ok:true, row:{code:row[0], title:row[1], payload:row[2], updatedAt:row[3]}}); }
        return _json({ok:false, error:'not_found'});
      }
      return _json({ok:false, error:'invalid_action'});
    }

    function doPost(e){
      const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_NAME);
      const body = JSON.parse(e.postData.contents||'{}');
      const code = (body.code||'').trim();
      const title = body.title||'';
      const payload = body.payload||'';
      const ts = new Date();
      if (!code || !payload) return _json({ok:false, error:'missing_fields'});
      const idx = _findRowByCode(sh, code);
      if (idx>-1) sh.getRange(idx+1,1,1,4).setValues([[code,title,payload,ts]]);
      else sh.appendRow([code,title,payload,ts]);
      return _json({ok:true, code});
    }
    ----- END APPS SCRIPT -----
  -->

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- LZ-String untuk kompresi -->
  <script defer src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <style>
    :root{
      --bg: #f7f7fb;       /* latar putih lembut */
      --card: #ffffff;     /* kartu putih */
      --text: #0f172a;     /* slate-900 */
      --muted:#64748b;     /* slate-500 */
      --ring:#e5e7eb;      /* gray-200 */
      --shadow: 0 8px 24px rgba(15,23,42,.08), 0 2px 6px rgba(15,23,42,.06);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; color:var(--text); background:var(--bg);}    

    /* Navbar sederhana (ada Home atas) */
    header{position:sticky; top:0; z-index:10; background:rgba(255,255,255,.9); backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid var(--ring);}    
    .nav{max-width:960px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:10px 16px}
    .brand{font-weight:700}
    .spacer{flex:1}
    .btn{appearance:none;border:1px solid var(--ring);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow);font-weight:600}
    .btn:hover{transform:translateY(-1px)}
    .btn.ghost{background:#fff;border:1px solid var(--ring);box-shadow:none}

    /* Halaman — tanpa frame 9:16, hanya dua tombol di tengah */
    .container{max-width:960px;margin:0 auto;padding:16px}
    #home{min-height:calc(100vh - 60px);display:grid;place-items:center}
    .home-actions{display:grid;gap:14px;grid-template-columns:1fr; width:min(320px,90vw)}

    /* Editor — kartu putih */
    #editor{display:none}
    .card{background:var(--card); border:1px solid var(--ring);border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; display:grid; gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .input,.select{appearance:none;border:1px solid var(--ring);background:#fff;border-radius:10px;padding:10px 12px;font:inherit;min-width:0}
    .input:focus,.select:focus{outline:2px solid #00000010}
    .grow{flex:1 1 auto}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;border:1px solid var(--ring);background:#fff}
    .icon-btn{border:1px solid var(--ring); background:#fff; width:34px;height:34px;border-radius:8px;display:grid;place-items:center;cursor:pointer}

    /* Rich Text Editor */
    .rte-toolbar{display:flex;gap:6px;flex-wrap:wrap}
    .rte-toolbar .icon-btn{width:auto;padding:8px 10px}
    .rte{min-height:260px;border:1px solid var(--ring);border-radius:10px;padding:12px;background:#fff}
    .rte:focus{outline:2px solid #00000010}

    /* Coding (textarea) */
    #codeWrap{display:none}
    .codebox{min-height:320px;border:1px solid var(--ring);border-radius:10px;padding:12px;background:#fff;font: 13px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;white-space:pre;overflow:auto}

    /* Meta */
    .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .meta a{color:inherit}

    /* Modal dasar */
    .modal{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;padding:20px}
    .dialog{width:100%;max-width:420px;background:#fff;border:1px solid var(--ring);border-radius:14px;box-shadow:var(--shadow);padding:16px;display:grid;gap:12px}

    /* Test results table */
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--ring);padding:8px;text-align:left}
    .pass{color:#16a34a;font-weight:700}
    .fail{color:#dc2626;font-weight:700}
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="brand">PasteMini</div>
      <button id="navHome" class="btn ghost">Home</button>
      <div class="spacer"></div>
      <button id="navCreate" class="btn">Create</button>
      <button id="navLoad" class="btn ghost">Load</button>
      <button id="navTest" class="btn ghost" title="Jalankan pengujian">Tests</button>
    </nav>
  </header>

  <main class="container">
    <!-- HOME: hanya dua tombol center, tanpa kotak -->
    <section id="home">
      <div class="home-actions">
        <button id="homeCreate" class="btn">Create Notes</button>
        <button id="homeLoad" class="btn ghost">Load Notes</button>
      </div>
    </section>

    <!-- EDITOR -->
    <section id="editor" class="card">
      <div class="row">
        <input id="title" class="input grow" placeholder="Judul catatan" />
        <select id="mode" class="select">
          <option value="text">Rich Text</option>
          <option value="code">Coding</option>
        </select>
        <select id="lang" class="select" title="Bahasa" style="display:none">
          <option value="plain" selected>Plain</option>
          <option value="html">HTML</option>
          <option value="javascript">JavaScript</option>
          <option value="markdown">Markdown</option>
          <option value="python">Python</option>
        </select>
      </div>

      <div class="row">
        <div class="chip">
          <span id="urlView">https://example.com/?n=demo</span>
          <button id="editSlug" class="icon-btn" title="Edit custom URL">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
          </button>
        </div>
        <input id="slug" class="input" placeholder="custom-slug" style="display:none"/>
        <div class="spacer"></div>
      </div>

      <!-- Rich Text -->
      <div id="rteWrap">
        <div class="rte-toolbar">
          <button class="icon-btn" data-cmd="bold"><b>B</b></button>
          <button class="icon-btn" data-cmd="italic"><i>I</i></button>
          <button class="icon-btn" data-cmd="underline"><u>U</u></button>
          <button class="icon-btn" data-cmd="insertUnorderedList">• List</button>
          <button class="icon-btn" data-cmd="insertOrderedList">1. List</button>
          <button class="icon-btn" data-cmd="formatBlock" data-val="H1">H1</button>
          <button class="icon-btn" data-cmd="formatBlock" data-val="H2">H2</button>
          <button class="icon-btn" id="linkBtn">Link</button>
          <input type="color" id="colorPick" title="Warna teks" />
          <button class="icon-btn" id="clearFmt">Clear</button>
        </div>
        <div id="rte" class="rte" contenteditable="true" spellcheck="false"></div>
      </div>

      <!-- Coding (textarea sederhana) -->
      <div id="codeWrap">
        <textarea id="codeBox" class="codebox" spellcheck="false" placeholder="/* Tulis/Tempel kode di sini (HTML, JS, Markdown, dll) */"></textarea>
      </div>

      <!-- Actions di bawah kotak teks -->
      <div class="row" id="actionRow">
        <div class="spacer"></div>
        <button id="btnSaveSheet" class="btn">Save to Sheet</button>
        <button id="btnDelete" class="btn ghost">Delete</button>
      </div>

      <!-- Share area: WA + Copy URL + Link tampil -->
      <div class="meta">
        <span id="status">Ready</span>
        <span>
          <a id="shareWA" href="https://wa.me/?text=https%3A%2F%2Fexample.com%2F%3Fn%3Ddemo" target="_blank" rel="noopener">Share WA</a>
          ·
          <a id="shareCopy" href="#">Copy URL</a>
        </span>
        <span>Link: <a id="shareUrl" href="https://example.com/?n=demo" target="_blank" rel="noopener">https://example.com/?n=demo</a></span>
      </div>
    </section>
  </main>

  <!-- Modal Load dari Google Sheet -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3>Load dari Google Sheet</h3>
      <input id="inpCode" class="input" placeholder="Masukkan Sheet Code (slug), misal: my-note"/>
      <div class="row" style="justify-content:end">
        <button id="btnCancel" class="btn ghost">Batal</button>
        <button id="btnLoadSheet" class="btn">Load</button>
      </div>
    </div>
  </div>

  <!-- Modal Tests -->
  <div id="testModal" class="modal" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3>Self Tests</h3>
      <div id="testBody">Menjalankan tes…</div>
      <div class="row" style="justify-content:end">
        <button id="btnCloseTests" class="btn">Tutup</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ================= CONFIG =================
  const SHEET_API = 'https://script.google.com/macros/s/AKfycbzZ168l7D_2oKoZbbHTLopamBSEkBNi5bHYqnzXolThHzh5TAY1-yV9u8wrXV2iwyQ/exec'; // GANTI dengan URL Web App milikmu
  const SHEET_TIMEOUT_MS = 8000;

  // ================ HELPERS ================
  const $ = sel => document.querySelector(sel);
  const byId = id => document.getElementById(id);
  const status = msg => { byId('status').textContent = msg; };
  const toast = (msg) => { status(msg); setTimeout(()=>status('Ready'), 1600); };
  const copy = async (txt) => { try { await navigator.clipboard.writeText(txt); toast('Disalin'); } catch(e){ console.warn(e); } };
  const makeId = (len=8) => { const arr = new Uint8Array(len); crypto.getRandomValues(arr); return Array.from(arr, b => (b % 36).toString(36)).join(''); };
  const slugify = s => (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  const enc = (obj) => LZString.compressToEncodedURIComponent(JSON.stringify(obj));
  const dec = (str) => JSON.parse(LZString.decompressFromEncodedURIComponent(str));
  const isSheetConfigured = () => SHEET_API && !SHEET_API.includes('PASTE_WEB_APP_URL');

  async function requestJSON(url, options={}){
    const ac = new AbortController();
    const id = setTimeout(()=>ac.abort(), SHEET_TIMEOUT_MS);
    try{
      const res = await fetch(url, { ...options, signal: ac.signal });
      clearTimeout(id);
      if (!res.ok){
        const text = await res.text().catch(()=>res.statusText);
        return { ok:false, error:`HTTP ${res.status} ${res.statusText}: ${text}` };
      }
      const data = await res.json();
      return { ok:true, data };
    }catch(err){
      clearTimeout(id);
      if (err.name === 'AbortError') return { ok:false, error:'Timeout – server tidak merespons' };
      return { ok:false, error: (err && err.message) || 'Failed to fetch' };
    }
  }

  // ================ STATE ================
  let currentId = null;  // internal id
  let currentSlug = '';

  const storeKey = (idOrSlug) => `pm:note:${idOrSlug}`; // masih dipakai untuk boot via ?n (fallback lokal jika mau tambahkan nanti)

  // ============== EDITOR I/O ==============
  function getEditorValue(){
    const mode = byId('mode').value;
    if (mode === 'code') return byId('codeBox').value;
    return byId('rte').innerHTML; // simpan HTML saat rich text
  }
  function setEditorValue(val){
    const mode = byId('mode').value;
    if (mode === 'code') byId('codeBox').value = val||'';
    else byId('rte').innerHTML = val||'';
  }

  // Rich Text actions
  function rteCmd(cmd, val=null){ document.execCommand(cmd, false, val); updateShareArtifacts(); }

  // ============== SHEET I/O ==============
  async function saveToSheet(){
    if (!isSheetConfigured()){ toast('SHEET_API belum dikonfigurasi'); return; }
    if (!navigator.onLine){ toast('Offline: tidak bisa simpan ke Sheet'); return; }
    if (!currentId) currentId = makeId();
    if (!currentSlug) currentSlug = slugify(byId('title').value) || makeId();
    byId('slug').value = currentSlug; byId('slug').dataset.manual = '1';
    const note = buildNoteObj();
    const payload = enc({ id: note.id, title: note.title, content: note.content, mode: note.mode, slug: note.slug });
    const code = currentSlug; // sheet code otomatis mengikuti URL (slug)
    const { ok, data, error } = await requestJSON(SHEET_API, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'save', code, title: note.title||'', payload })
    });
    if (!ok){ console.warn(error); toast('Gagal simpan Sheet: ' + error); return; }
    if (data && data.ok){ toast('Tersimpan (Sheet)'); updateURLView(); }
    else { toast('Gagal simpan Sheet'); }
  }

  async function loadFromSheet(code){
    if (!isSheetConfigured()){ toast('SHEET_API belum dikonfigurasi'); return; }
    if (!navigator.onLine){ toast('Offline: tidak bisa load dari Sheet'); return; }
    const { ok, data, error } = await requestJSON(`${SHEET_API}?action=get&code=${encodeURIComponent(code)}`);
    if (!ok){ console.warn(error); toast('Gagal load Sheet: ' + error); return; }
    if (data && data.ok && data.row && data.row.payload){
      const obj = dec(data.row.payload);
      currentSlug = code; // sheet code mengikuti URL
      setFromNoteObj({ id: obj.id, title: obj.title, content: obj.content, mode: obj.mode, slug: currentSlug, updatedAt: Date.now() });
      toast('Dimuat (Sheet)'); hideModal();
    } else { toast('Kode tidak ditemukan'); }
  }

  // ============== HELPERS ==============
  function buildNoteObj(){ return { id: currentId || makeId(), title: byId('title').value || '', content: getEditorValue() || '', mode: byId('mode').value || 'text', slug: currentSlug || '', updatedAt: Date.now() }; }
  function setFromNoteObj(note){ currentId = note.id; currentSlug = note.slug || ''; byId('title').value = note.title || ''; byId('mode').value = note.mode || 'text'; toggleModeUI(); setEditorValue(note.content || ''); showEditor(); updateShareArtifacts(); }
  function clearEditor(){ currentId=null; currentSlug=''; byId('title').value=''; byId('mode').value='text'; toggleModeUI(); setEditorValue(''); }

  // URL/Slug & Share
  function updateURLView(){
    const base = location.origin + location.pathname;
    const slug = currentSlug ? `?n=${encodeURIComponent(currentSlug)}` : '?n=demo';
    const full = base + slug;
    byId('urlView').textContent = full;
    byId('shareUrl').href = full; byId('shareUrl').textContent = full;
    byId('shareCopy').onclick = (e)=>{ e.preventDefault(); copy(full); };
    byId('shareWA').href = `https://wa.me/?text=${encodeURIComponent(full)}`;
  }
  function autoSlugFromTitle(){ const t = byId('title').value; if (!byId('slug').dataset.manual){ currentSlug = slugify(t); byId('slug').value = currentSlug; updateURLView(); } }
  function enableSlugEdit(){ byId('slug').style.display='inline-block'; byId('slug').focus(); byId('slug').select(); byId('slug').dataset.manual = '1'; }

  function updateShareArtifacts(){ autoSlugFromTitle(); updateURLView(); }
  function importFromCode(code){ try{ const note = dec(code); setFromNoteObj({ id: note.id || makeId(), title: note.title || '', content: note.content || '', mode: note.mode || 'text', slug: slugify(note.slug || ''), updatedAt: Date.now() }); toast('Kode dimuat'); }catch(err){ console.error(err); toast('Kode tidak valid'); } }

  // ============== UI FLOW ==============
  function showHome(){ byId('home').style.display='grid'; byId('editor').style.display='none'; }
  function showEditor(){ byId('home').style.display='none'; byId('editor').style.display='grid'; }
  function createNew(){ clearEditor(); currentId = makeId(); showEditor(); updateShareArtifacts(); }
  function showModal(){ byId('modal').style.display='flex'; byId('inpCode').value=''; byId('inpCode').focus(); }
  function hideModal(){ byId('modal').style.display='none'; }
  function showTests(){ byId('testModal').style.display='flex'; runSelfTests(); }
  function hideTests(){ byId('testModal').style.display='none'; }

  function toggleModeUI(){
    const mode = byId('mode').value; const rteWrap = byId('rteWrap'); const codeWrap = byId('codeWrap'); const langSel = byId('lang');
    if (mode==='code'){
      rteWrap.style.display='block'; // toolbar tetap terlihat (boleh dipakai buat copy text)
      codeWrap.style.display='block'; langSel.style.display='inline-block';
      byId('codeBox').focus();
      if (!byId('codeBox').value) byId('codeBox').value = byId('rte').innerText || '';
    } else {
      codeWrap.style.display='none'; langSel.style.display='none';
      if (byId('codeBox').value) byId('rte').innerText = byId('codeBox').value;
    }
  }

  // ============== EVENTS ==============
  // Nav / Home
  byId('navHome').onclick = showHome; byId('homeCreate').onclick = createNew; byId('navCreate').onclick = createNew;
  byId('homeLoad').onclick = showModal; byId('navLoad').onclick = showModal; byId('navTest').onclick = showTests; byId('btnCloseTests').onclick = hideTests;

  // Modal
  byId('btnCancel').onclick = hideModal; byId('btnLoadSheet').onclick = ()=>{ const code=byId('inpCode').value.trim(); if (code) loadFromSheet(code); };

  // Save/Delete
  byId('btnSaveSheet').onclick = saveToSheet; byId('btnDelete').onclick = ()=>{ if (!currentId){ toast('Belum ada catatan'); return; } const ok = confirm('Hapus catatan ini?'); if (!ok) return; clearEditor(); showHome(); toast('Dihapus'); };

  // Mode & Lang
  byId('mode').addEventListener('change', ()=>{ toggleModeUI(); updateShareArtifacts(); });
  byId('lang').addEventListener('change', ()=>{ /* placeholder: bisa dipakai untuk logic tambahan */ });

  // Title & Slug
  byId('title').addEventListener('input', updateShareArtifacts);
  byId('editSlug').onclick = enableSlugEdit;
  byId('slug').addEventListener('input', ()=>{ currentSlug = slugify(byId('slug').value); updateShareArtifacts(); });

  // RTE toolbar
  document.querySelectorAll('.rte-toolbar .icon-btn[data-cmd]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ const cmd = btn.dataset.cmd; const val = btn.dataset.val || null; if (cmd==='formatBlock' && val) rteCmd(cmd, `<${val}>`); else rteCmd(cmd, val); });
  });
  byId('linkBtn').onclick = ()=>{ const url = prompt('Masukkan URL:','https://'); if (url) rteCmd('createLink', url); };
  byId('clearFmt').onclick = ()=>rteCmd('removeFormat');
  byId('colorPick').addEventListener('input', (e)=>rteCmd('foreColor', e.target.value));

  // Deep link
  function bootFromURL(){
    const params = new URLSearchParams(location.search);
    const slug = params.get('n');
    const hash = location.hash;
    if (hash.startsWith('#c=')){
      importFromCode(hash.slice(3));
      return;
    }
    if (slug){
      currentSlug = slug;
      if (isSheetConfigured()){
        loadFromSheet(slug);
        return;
      }
    }
    showHome();
    updateURLView();
  }

  // ============== SELF TESTS ==============
  async function runSelfTests(){
    const rows = [];
    function add(name, pass, note=''){ rows.push(`<tr><td>${name}</td><td class="${pass?'pass':'fail'}">${pass?'PASS':'FAIL'}</td><td>${note||''}</td></tr>`); }

    // T1: LZ roundtrip
    try{ const obj={a:1,b:'x'}; const z=enc(obj); const back=dec(z); add('LZ roundtrip', JSON.stringify(obj)===JSON.stringify(back)); }
    catch(e){ add('LZ roundtrip', false, e.message); }

    // T2: URL/slug live link tidak null
    try{ currentSlug='unit-test'; updateURLView(); const href = byId('shareUrl').getAttribute('href')||''; add('Live link', href.includes('?n=unit-test')); }
    catch(e){ add('Live link', false, e.message); }

    // T3: Coding textarea bisa diketik
    try{ byId('mode').value='code'; toggleModeUI(); byId('codeBox').value='console.log(1)'; add('Coding textarea input', byId('codeBox').value.includes('console.log')); }
    catch(e){ add('Coding textarea input', false, e.message); }

    // T4: Sheet config present
    add('Sheet API configured', isSheetConfigured());

    // T5: Sheet ping (opsional jika configured)
    if (isSheetConfigured()){
      const r = await requestJSON(`${SHEET_API}?action=ping`);
      add('Sheet ping', !!r.ok && r.data && r.data.ok, r.error||'');
    }else{
      add('Sheet ping', true, 'Lewati (belum dikonfigurasi)');
    }

    byId('testBody').innerHTML = `<table><thead><tr><th>Test</th><th>Status</th><th>Catatan</th></tr></thead><tbody>${rows.join('')}</tbody></table>`;
  }

  // Init
  toggleModeUI(); bootFromURL();
})();
</script>
</body>
</html>
