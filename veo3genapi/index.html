<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Veo 3 Video Generator • Gemini API</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .status-dot { width: .6rem; height: .6rem; border-radius: 9999px; display:inline-block; margin-left:.35rem; box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset; }
    .logbox { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal { background: #fff; width: 760px; max-width: 94vw; border-radius: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,.2); overflow: hidden; animation: pop .16s ease-out; }
    @keyframes pop { from { transform: translateY(8px); opacity:.95 } to { transform: translateY(0); opacity:1 } }
    .badge { font-size: 11px; padding: 2px 8px; border-radius: 9999px; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="border-b bg-white/60 backdrop-blur supports-[backdrop-filter]:bg-white/60 sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <h1 class="text-lg sm:text-xl font-semibold text-gray-800">Veo 3 Video Generator</h1>
        <span id="apiStatusDot" class="status-dot bg-rose-500"></span>
        <span id="connBadge" class="badge bg-gray-200 text-gray-700 hidden">offline</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnOpenApiModal" type="button" class="px-3 py-1.5 rounded-full bg-emerald-600 hover:bg-emerald-700 text-white text-sm cursor-pointer">Pasang API Gemini</button>
        <button id="btnCheckConn" type="button" class="px-3 py-1.5 rounded-full bg-blue-600 hover:bg-blue-700 text-white text-sm">Tes Koneksi</button>
        <a class="px-3 py-1.5 rounded-full bg-gray-900 hover:bg-black text-white text-sm" href="#howto">Cara Pakai</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6">
    <div class="grid lg:grid-cols-5 gap-6">
      <!-- Left: Controls -->
      <section class="lg:col-span-2 bg-white rounded-2xl shadow p-4 sm:p-6">
        <h2 class="text-base font-semibold text-gray-800 mb-3">Pengaturan</h2>

        <div class="grid gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1" for="modelSelect">Model</label>
            <div class="flex gap-2 items-center">
              <select id="modelSelect" class="bg-gray-100 rounded-full px-3 py-2 text-sm text-gray-800">
                <option value="veo-3.0-generate-preview" selected>veo-3.0-generate-preview</option>
                <option value="veo-3.0-fast-generate-preview">veo-3.0-fast-generate-preview</option>
              </select>
              <button id="btnListModels" class="text-xs px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-gray-700" title="Cek model via API">Cek Model</button>
            </div>
            <p id="regionNote" class="text-[11px] text-gray-500 mt-1">Catatan: Veo 3 (Preview) biasanya 8 detik, 720p, 24fps, dengan audio native.</p>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1" for="prompt">Prompt Video</label>
            <textarea id="prompt" rows="5" placeholder='Contoh: "Close-up cinematic cangkir kopi beruap di balik jendela saat hujan; ambience hujan, piano lembut."' class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1" for="negative">Negative Prompt (opsional)</label>
              <input id="negative" type="text" placeholder="blurry, low quality, cartoon" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1" for="aspect">Aspect Ratio</label>
              <select id="aspect" class="w-full bg-gray-100 rounded-lg px-3 py-2 border border-gray-300">
                <option value="16:9" selected>16:9 (disarankan)</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Gambar Awal (opsional)</label>
            <input id="imageInput" type="file" accept="image/*" class="block w-full text-sm text-gray-600 file:mr-3 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-900 file:text-white hover:file:bg-black" />
            <p class="text-[11px] text-gray-500 mt-1">Jika diisi, Veo akan membuat video <em>image-to-video</em> dari frame awal ini.</p>
            <img id="imagePreview" class="mt-2 hidden max-h-40 rounded-lg border" alt="Preview" />
          </div>

          <div class="flex items-center gap-3">
            <button id="btnGenerate" class="px-4 py-2 rounded-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold">Generate Video</button>
            <button id="btnCancel" class="px-4 py-2 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-800" disabled>Batalkan</button>
          </div>
        </div>
      </section>

      <!-- Right: Output -->
      <section class="lg:col-span-3 bg-white rounded-2xl shadow p-4 sm:p-6">
        <h2 class="text-base font-semibold text-gray-800 mb-3">Hasil</h2>
        <div id="progress" class="hidden mb-3">
          <div class="flex items-center gap-3">
            <div class="animate-spin inline-block w-6 h-6 border-4 border-blue-500 border-t-transparent rounded-full"></div>
            <p id="progressText" class="text-sm text-gray-700">Menyiapkan…</p>
          </div>
        </div>

        <div id="log" class="logbox text-xs bg-gray-50 border rounded-lg p-3 h-36 overflow-auto"></div>

        <div id="result" class="mt-4 hidden">
          <div class="flex items-center justify-between mb-2">
            <div>
              <p class="text-sm text-gray-600">Operation: <span id="opName" class="font-mono"></span></p>
            </div>
            <div class="flex gap-2">
              <a id="btnOpenVideo" href="#" target="_blank" rel="noopener" class="hidden px-3 py-1.5 rounded-md bg-blue-600 text-white text-sm">Buka di Tab Baru</a>
              <a id="btnDownload" href="#" download="veo3_video.mp4" class="hidden px-3 py-1.5 rounded-md bg-blue-600 text-white text-sm">Download MP4</a>
              <button id="btnCopyUri" class="hidden px-3 py-1.5 rounded-md bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm">Salin File URI</button>
            </div>
          </div>
          <video id="videoPlayer" class="w-full rounded-xl border" controls></video>
        </div>
      </section>
    </div>

    <section id="howto" class="max-w-3xl mt-8 text-sm text-gray-700">
      <h3 class="text-base font-semibold text-gray-800">Catatan & Cara Pakai</h3>
      <ul class="list-disc ml-5 mt-2 space-y-1">
        <li>Klik <b>Pasang API Gemini</b> dan tempel API key dari <a class="text-blue-600 underline" href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener">Google AI Studio</a>.</li>
        <li>Pilih model: <code>veo-3.0-generate-preview</code> (kualitas) atau <code>veo-3.0-fast-generate-preview</code> (lebih cepat).</li>
        <li>Video yang dihasilkan umumnya <b>8 detik, 720p, 24fps</b>, dengan audio bawaan. Simpan segera: server hanya menyimpan video sekitar <b>2 hari</b>.</li>
        <li>Jika regional policy membatasi, prompt orang bisa diblokir oleh safety filter.</li>
      </ul>
    </section>

    <!-- Self-test (otomatisasi sederhana) -->
    <section class="max-w-3xl mt-8 text-sm text-gray-700">
      <h3 class="text-base font-semibold text-gray-800">Self Test</h3>
      <p class="mb-2">Klik tombol di bawah untuk memastikan fungsi modal, binding event, dan penanganan error jaringan.</p>
      <div class="flex items-center gap-2">
        <button id="btnRunTests" class="px-3 py-1.5 rounded-md bg-gray-900 text-white">Run Self Tests</button>
        <span id="testSummary" class="text-sm"></span>
      </div>
      <ul id="testList" class="list-disc ml-5 mt-2 space-y-1"></ul>
    </section>
  </main>

  <!-- API Modal -->
  <div id="apiModal" class="modal-overlay">
    <div class="modal">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-semibold text-gray-800">Pasang API Gemini</h3>
        <button id="btnCloseApi" class="p-2 rounded-md hover:bg-gray-100" aria-label="Tutup">✕</button>
      </div>
      <div class="p-5">
        <div class="mb-3 grid sm:grid-cols-2 gap-4">
          <div class="sm:col-span-2">
            <label for="apiKeyInput" class="block text-sm font-semibold text-gray-700 mb-1">API Key</label>
            <input id="apiKeyInput" type="password" placeholder="Masukkan API Key Gemini Anda" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" autocomplete="off">
            <p id="apiStatusTxt" class="text-xs text-gray-500 mt-1">Status: <span class="font-medium">Belum dipasang</span></p>
          </div>
          <div>
            <label for="apiBaseInput" class="block text-sm font-semibold text-gray-700 mb-1">API Base URL</label>
            <input id="apiBaseInput" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="https://generativelanguage.googleapis.com/v1beta">
            <p class="text-[11px] text-gray-500 mt-1">Opsional. Ganti bila pakai versi lain/region.</p>
          </div>
          <div>
            <label for="corsProxyInput" class="block text-sm font-semibold text-gray-700 mb-1">CORS Proxy (opsional)</label>
            <input id="corsProxyInput" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="https://cors.isomorphic-git.org/{url}">
            <p class="text-[11px] text-gray-500 mt-1">Gunakan <code>{url}</code> sebagai placeholder. Jika tidak ada, akan disambung otomatis.</p>
          </div>
        </div>
        <div class="flex flex-wrap gap-2 mb-2">
          <button id="btnSaveKey" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg">Simpan</button>
          <button id="btnTestKey" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Uji Kunci</button>
          <button id="btnTestConn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Tes Koneksi</button>
          <button id="btnClearKey" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Hapus</button>
        </div>
        <details class="mt-3">
          <summary class="cursor-pointer text-sm text-gray-700 font-medium select-none">Cara mendapatkan API Gemini</summary>
          <ol class="text-sm text-gray-600 mt-2 list-decimal ml-5 space-y-1">
            <li>Kunjungi <a class="text-blue-600 underline" href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener">Google AI Studio – API Keys</a>.</li>
            <li>Login & klik <em>Create API key</em>.</li>
            <li>Salin kuncinya (format: <code>AI..._...</code>), tempel di kolom di atas lalu klik <b>Simpan</b>.</li>
            <li><b>Catatan:</b> Kunci & konfigurasi disimpan lokal di browser (<i>localStorage</i>).</li>
          </ol>
        </details>
      </div>
      <div class="px-5 py-4 border-t flex items-center justify-end">
        <button id="btnCloseApi2" class="px-4 py-2 rounded-lg bg-gray-800 text-white hover:bg-black">Selesai</button>
      </div>
    </div>
  </div>

  <script>
    // ========================
    //  DEFINISI & UTILITAS
    // ========================

    const KEY_STORAGE = 'gemini_api_key';
    const BASE_DEFAULT = 'https://generativelanguage.googleapis.com/v1beta'; // default public REST base
    const BASE_KEY = 'gemini_api_base';
    const PROXY_KEY = 'cors_proxy_url';

    const $ = (id) => document.getElementById(id);
    const logEl = () => $('log');

    function log(msg){
      const t = new Date().toLocaleTimeString();
      if (logEl()) {
        logEl().textContent += `[${t}] ${msg}
`;
        logEl().scrollTop = logEl().scrollHeight;
      }
      console.debug('[LOG]', msg);
    }

    function getApiKey(){ return localStorage.getItem(KEY_STORAGE) || ''; }
    function setApiKey(v){ if (v) localStorage.setItem(KEY_STORAGE, v); else localStorage.removeItem(KEY_STORAGE); renderApiStatus(); }

    function getApiBase(){ return localStorage.getItem(BASE_KEY) || BASE_DEFAULT; }
    function setApiBase(v){ if (v) localStorage.setItem(BASE_KEY, v); else localStorage.removeItem(BASE_KEY); }

    function getProxy(){ return (localStorage.getItem(PROXY_KEY) || '').trim(); }
    function setProxy(v){ if (v) localStorage.setItem(PROXY_KEY, v); else localStorage.removeItem(PROXY_KEY); }

    function buildUrl(path){
      const base = getApiBase().replace(/\/$/, '');
      return `${base}${path.startsWith('/') ? '' : '/'}${path}`;
    }

    // FIX: previously contained stray characters causing a JS parse error
    function wrapWithProxy(fullUrl){
      const pRaw = getProxy();
      const p = (pRaw || '').trim();
      if (!p) return fullUrl;
      // For proxies like cors.isomorphic-git.org, do NOT percent-encode {url}
      if (p.includes('{url}')) return p.replace('{url}', fullUrl);
      return p.replace(/\/$/, '') + '/' + fullUrl; // naive join (no encoding)
    }

    async function safeFetchJson(url, options = {}, extra = {}){
      const { expectJson = true, simulateNetworkError = false } = extra;
      if (simulateNetworkError) {
        return { ok: false, status: 0, isNetworkError: true, error: 'Simulated network error' };
      }
      try {
        const res = await fetch(url, options);
        if (!res.ok) {
          let msg = `HTTP ${res.status}`;
          let errBody = null;
          try { errBody = await res.json(); if (errBody?.error?.message) msg += ` — ${errBody.error.message}`; } catch {}
          return { ok: false, status: res.status, error: msg, body: errBody };
        }
        if (!expectJson) return { ok: true, status: res.status, body: await res.text() };
        const jd = await res.json();
        return { ok: true, status: res.status, body: jd };
      } catch (e) {
        // TypeError: Failed to fetch -> jaringan/CORS
        return { ok: false, status: 0, isNetworkError: true, error: e?.message || 'Failed to fetch' };
      }
    }

    function renderApiStatus(){
      const has = !!getApiKey();
      const dot = $('apiStatusDot');
      if (dot){
        dot.classList.toggle('bg-emerald-500', has);
        dot.classList.toggle('bg-rose-500', !has);
      }
      const txt = $('apiStatusTxt');
      if (txt) txt.innerHTML = 'Status: ' + (has ? '<span class="text-emerald-700 font-semibold">Terpasang</span>' : '<span class="text-rose-700 font-semibold">Belum dipasang</span>');
      const g = $('btnGenerate'); if (g) g.disabled = !has;
    }

    function setConnectivityBadge(online, reason){
      const b = $('connBadge');
      if (!b) return;
      b.classList.remove('hidden');
      b.textContent = online ? 'online' : (reason ? `offline: ${reason}` : 'offline');
      b.classList.toggle('bg-green-100', online);
      b.classList.toggle('text-green-700', online);
      b.classList.toggle('bg-gray-200', !online);
      b.classList.toggle('text-gray-700', !online);
    }

    function openApiModal(){
      const m=$('apiModal');
      if (m) m.style.display='flex';
      const i=$('apiKeyInput'); if (i) i.value = getApiKey();
      const b=$('apiBaseInput'); if (b) b.value = getApiBase();
      const p=$('corsProxyInput'); if (p) p.value = getProxy();
      renderApiStatus();
      // autofocus ke input API key
      setTimeout(()=>{ $('apiKeyInput')?.focus(); }, 0);
    }
    function closeApiModal(){ const m=$('apiModal'); if (m) m.style.display='none'; }

    async function testConnectivity(){
      const key = getApiKey();
      if (!key) { openApiModal(); alert('Masukkan API Key dulu.'); return; }
      const url = wrapWithProxy(buildUrl('/models?key=' + encodeURIComponent(key)));
      log('Tes koneksi: GET ' + url);
      const r = await safeFetchJson(url, { method: 'GET' }, {});
      if (r.ok) { setConnectivityBadge(true); log('Koneksi OK. Jumlah model: ' + (r.body?.models?.length ?? 'n/a')); alert('Koneksi OK.'); }
      else {
        const reason = r.isNetworkError ? 'network/CORS' : ('HTTP ' + r.status);
        setConnectivityBadge(false, reason);
        log('Tes koneksi gagal: ' + (r.error || reason));
        alert('Tes koneksi gagal: ' + (r.error || reason) + "
Coba isi CORS Proxy di modal (gunakan {url}).");
      }
    }

    async function testApiKey(){
      const input = $('apiKeyInput');
      const key = (input && input.value.trim()) || getApiKey();
      if (!key) { log('Masukkan API Key dulu untuk diuji.'); alert('Masukkan API Key dulu untuk diuji.'); return; }
      const url = wrapWithProxy(buildUrl('/models?key=' + encodeURIComponent(key)));
      log('Uji kunci: GET ' + url);
      const r = await safeFetchJson(url, { method: 'GET' });
      if (r.ok) { log('API Key valid.'); alert('API Key valid.'); setConnectivityBadge(true); }
      else { const reason = r.isNetworkError ? 'network/CORS' : ('HTTP ' + r.status); log('Tes API gagal: ' + (r.error || reason)); alert('Tes API gagal: ' + (r.error || reason) + "
Jika CORS, isi field CORS Proxy."); setConnectivityBadge(false, reason); }
    }

    function setBusy(on){
      const p=$('progress'); if (p) p.classList.toggle('hidden', !on);
      const g=$('btnGenerate'); if (g) g.disabled = on || !getApiKey();
      const c=$('btnCancel'); if (c) c.disabled = !on;
    }

    // Optional: cancel via flag only (no server cancel API)
    let CANCEL_FLAG = false;

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
    function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); }); }
    function base64ToBlob(b64, mime) { const bin = atob(b64); const len = bin.length; const arr = new Uint8Array(len); for (let i=0;i<len;i++) arr[i] = bin.charCodeAt(i); return new Blob([arr], { type: mime }); }

    async function pollOperation(name, apiKey, onTick){
      let tries = 0;
      while (true) {
        await sleep(7000);
        tries++;
        onTick?.(tries);
        log('Polling status…');
        // Use the exact name path from the API (operations/... or models/.../operations/...)
        const opPath = (name.startsWith('operations/') || name.startsWith('models/'))
          ? '/' + encodeURI(name) // keep slashes
          : '/operations/' + encodeURIComponent(name);
        const url = wrapWithProxy(buildUrl(opPath + '?key=' + encodeURIComponent(apiKey)));
        const r = await safeFetchJson(url, { method: 'GET' });
        if (!r.ok) {
          const reason = r.isNetworkError ? 'network/CORS' : ('HTTP ' + r.status);
          if (r.status === 404) log('Polling 404: kemungkinan path salah (gandakan "operations/").');
          log(`Gagal polling (${reason}).`);
          continue;
        }
        const jd = r.body;
        if (jd.done) {
          log('Operasi selesai.');
          const rv = jd.response || jd.result || {};
          const arr = rv.generatedVideos || rv.generated_videos || [];
          const video = arr[0]?.video || arr[0]?.Video || null;
          if (video?.uri) return { uri: video.uri, mimeType: video.mimeType };
          if (video?.videoBytes) return { videoBytes: video.videoBytes, mimeType: video.mimeType };
          if (rv?.file?.uri) return { uri: rv.file.uri, mimeType: rv.file.mimeType };
          return null;
        } else {
          const meta = jd.metadata || {};
          if (meta.progressPercent) log(`Progres: ${meta.progressPercent}%`);
        }
      }
    }

    async function generate(){
      const apiKey = getApiKey();
      if (!apiKey) { openApiModal(); return; }

      const model = $('modelSelect').value;
      const prompt = $('prompt').value.trim();
      const negative = $('negative').value.trim();
      const aspect = $('aspect').value;

      if (!prompt) { alert('Prompt tidak boleh kosong.'); return; }

      $('result').classList.add('hidden');
      $('videoPlayer').src = '';
      $('btnDownload').classList.add('hidden');
      $('btnOpenVideo').classList.add('hidden');
      $('btnCopyUri').classList.add('hidden');
      $('opName').textContent = '';
      $('progressText').textContent = 'Mengirim permintaan…';
      if (logEl()) logEl().textContent = '';
      CANCEL_FLAG = false;
      setBusy(true);

      try {
        const instances = [{ prompt }];
        const imgFile = $('imageInput').files?.[0];
        if (imgFile) {
          const base64 = await fileToBase64(imgFile);
          const b64 = base64.split(',')[1];
          instances[0].image = { imageBytes: b64, mimeType: imgFile.type || 'image/png' };
        }
        const parameters = { aspectRatio: aspect };
        if (negative) parameters.negativePrompt = negative;

        const submitUrl = wrapWithProxy(buildUrl('/models/' + encodeURIComponent(model) + ':predictLongRunning?key=' + encodeURIComponent(apiKey)));
        const r = await safeFetchJson(submitUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ instances, parameters })
        });

        if (!r.ok) {
          const reason = r.isNetworkError ? 'network/CORS' : ('HTTP ' + r.status);
          throw new Error(`Gagal submit job (${reason}). ${r.error || ''}`);
        }

        const op = r.body;
        const opName = op?.name || op?.operation?.name;
        if (!opName) throw new Error('Tidak menerima nama operasi.');
        $('opName').textContent = opName;
        log('Job dimulai: ' + opName);
        $('progressText').textContent = 'Menunggu hasil (sekitar 10–180 detik)…';

        const videoInfo = await pollOperation(opName, apiKey, () => { if (CANCEL_FLAG) throw new Error('Dibatalkan oleh pengguna.'); });
        if (!videoInfo) throw new Error('Respons selesai tanpa video.');

        const { uri, videoBytes, mimeType } = videoInfo;
        if (uri) {
          $('videoPlayer').src = uri;
          $('btnOpenVideo').href = uri;
          $('btnDownload').href = uri;
          $('btnCopyUri').onclick = () => navigator.clipboard.writeText(uri);
          $('btnOpenVideo').classList.remove('hidden');
          $('btnDownload').classList.remove('hidden');
          $('btnCopyUri').classList.remove('hidden');
        } else if (videoBytes) {
          const blob = base64ToBlob(videoBytes, mimeType || 'video/mp4');
          const urlObj = URL.createObjectURL(blob);
          $('videoPlayer').src = urlObj;
          $('btnDownload').href = urlObj;
          $('btnDownload').classList.remove('hidden');
        }

        $('result').classList.remove('hidden');
        $('progressText').textContent = 'Selesai';
        log('Selesai. Segera download: file hanya tersimpan ±2 hari.');
      } catch (err) {
        console.error(err);
        alert('Gagal: ' + (err?.message || err));
        log('Error: ' + (err?.message || err));
      } finally {
        setBusy(false);
      }
    }

    function cancel(){ CANCEL_FLAG = true; log('Mencoba membatalkan (client-side)…'); setBusy(false); }

    // ========================
    //    BINDING SETELAH DOM READY
    // ========================
    document.addEventListener('DOMContentLoaded', () => {
      renderApiStatus();

      // Bind tombol modal API
      const btnApi = $('btnOpenApiModal'); if (btnApi) btnApi.addEventListener('click', openApiModal);
      const close1 = $('btnCloseApi'); if (close1) close1.addEventListener('click', closeApiModal);
      const close2 = $('btnCloseApi2'); if (close2) close2.addEventListener('click', closeApiModal);
      const modal = $('apiModal'); if (modal) modal.addEventListener('click', (e)=>{ if (e.target.id === 'apiModal') closeApiModal(); });

      // Bind API actions
      const save = $('btnSaveKey'); if (save) save.addEventListener('click', ()=>{ const k=$('apiKeyInput').value.trim(); const b=$('apiBaseInput').value.trim(); const p=$('corsProxyInput').value.trim(); if(!k){ alert('API Key kosong.'); return; } setApiKey(k); setApiBase(b||BASE_DEFAULT); setProxy(p); alert('Disimpan.'); renderApiStatus(); });
      const clear = $('btnClearKey'); if (clear) clear.addEventListener('click', ()=>{ $('apiKeyInput').value=''; setApiKey(''); setApiBase(''); setProxy(''); alert('API Key & konfigurasi dihapus.'); renderApiStatus(); });
      const test = $('btnTestKey'); if (test) test.addEventListener('click', testApiKey);
      const testConnBtn = $('btnTestConn'); if (testConnBtn) testConnBtn.addEventListener('click', testConnectivity);
      const quickConn = $('btnCheckConn'); if (quickConn) quickConn.addEventListener('click', testConnectivity);

      // Bind generator
      const gen = $('btnGenerate'); if (gen) gen.addEventListener('click', generate);
      const cancelBtn = $('btnCancel'); if (cancelBtn) cancelBtn.addEventListener('click', cancel);

      // Image preview
      const imgInput = $('imageInput');
      if (imgInput) {
        imgInput.addEventListener('change', (e)=>{
          const f = e.target.files?.[0];
          const preview = $('imagePreview');
          if (!f) { if (preview){ preview.classList.add('hidden'); preview.src=''; } return; }
          const reader = new FileReader();
          reader.onload = () => { if (preview){ preview.src = reader.result; preview.classList.remove('hidden'); } };
          reader.readAsDataURL(f);
        });
      }

      // Self tests
      const runBtn = $('btnRunTests'); if (runBtn) runBtn.addEventListener('click', runSelfTests);
    });

    // ========================
    //        SELF TESTS
    // ========================
    function addTestLine(ok, msg){
      const li = document.createElement('li');
      li.textContent = (ok? '✅ ' : '❌ ') + msg;
      const ul = $('testList'); if (ul) ul.appendChild(li);
    }

    function clearTests(){ const ul = $('testList'); if (ul) ul.innerHTML=''; const s=$('testSummary'); if (s) s.textContent=''; }

    async function runSelfTests(){
      clearTests();
      let passed = 0, total = 0;

      // Test 1: fungsi openApiModal tersedia
      total++; try { const ok = typeof openApiModal === 'function'; addTestLine(ok, 'openApiModal() terdefinisi'); if (ok) passed++; } catch { addTestLine(false, 'openApiModal() error saat dicek'); }

      // Test 2: klik tombol membuka modal
      total++;
      try {
        const btn = $('btnOpenApiModal'); const modal = $('apiModal');
        let ok=false; if (btn && modal){ btn.click(); ok = (modal.style.display === 'flex' || !modal.classList.contains('hidden')); }
        addTestLine(ok, 'Klik tombol "Pasang API Gemini" membuka modal'); if (ok) passed++;
        const close = $('btnCloseApi'); if (close) close.click();
      } catch { addTestLine(false, 'Gagal mensimulasikan klik tombol modal'); }

      // Test 3: safeFetchJson mengembalikan error jaringan dengan simulasi
      total++;
      try {
        const r = await safeFetchJson('https://invalid.invalid', {}, { simulateNetworkError: true });
        const ok = !r.ok && r.isNetworkError; addTestLine(ok, 'safeFetchJson() menangani network error (simulasi)'); if (ok) passed++;
      } catch { addTestLine(false, 'safeFetchJson() gagal pada simulasi network error'); }

      // Test 4: buildUrl & proxy join
      total++;
      try {
        setApiBase('https://example.com/api'); setProxy('https://proxy.test/{url}');
        const full = buildUrl('/models');
        const wrapped = wrapWithProxy(full);
        const ok = full === 'https://example.com/api/models' && wrapped === 'https://proxy.test/' + full;
        addTestLine(ok, 'buildUrl()/wrapWithProxy() membentuk URL yang benar'); if (ok) passed++;
        // cleanup
        setApiBase(BASE_DEFAULT); setProxy('');
      } catch { addTestLine(false, 'buildUrl()/wrapWithProxy() gagal'); }

      // Test 5: operations URL menggunakan path {name} langsung (hindari gandakan segment)
      total++;
      try {
        const apiKey = 'AIzA...dummy';
        const name1 = 'operations/op123';
        const url1 = buildUrl('/' + encodeURI(name1) + '?key=' + encodeURIComponent(apiKey));
        const ok1 = url1.endsWith('/operations/op123?key=' + encodeURIComponent(apiKey));

        const name2 = 'models/veo-3.0-fast-generate-preview/operations/op456';
        const url2 = buildUrl('/' + encodeURI(name2) + '?key=' + encodeURIComponent(apiKey));
        const ok2 = url2.includes('/models/veo-3.0-fast-generate-preview/operations/op456?key=');

        addTestLine(ok1 && ok2, 'Polling memakai /{name}?key= (tanpa duplikasi /operations)'); if (ok1 && ok2) passed++;
      } catch { addTestLine(false, 'Cek operations URL gagal'); }

      // Test 6: proxy placeholder tidak di-encode (khusus isomorphic-git)
      total++;
      try {
        setProxy('https://cors.isomorphic-git.org/{url}');
        const full = buildUrl('/models?key=XYZ');
        const wrapped = wrapWithProxy(full);
        const ok = wrapped === 'https://cors.isomorphic-git.org/' + full; // no percent-encoding
        addTestLine(ok, 'CORS proxy tidak melakukan percent-encode pada {url}'); if (ok) passed++;
        setProxy('');
      } catch { addTestLine(false, 'Cek proxy placeholder gagal'); }

      const s=$('testSummary'); if (s) s.textContent = `Hasil: ${passed}/${total} tes lulus`;
      console.log(`Self tests: ${passed}/${total} passed`);
    }

    // Ekspos fungsi ke window bila diperlukan
    window.openApiModal = openApiModal;
    window.closeApiModal = closeApiModal;
  </script>
</body>
</html>
